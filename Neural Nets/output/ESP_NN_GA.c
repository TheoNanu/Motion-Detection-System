#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#define INPUT_SIZE 8
#define OUTPUT_SIZE 1

#define ADD(a, b) (a + b)
#define SUBTRACT(a, b) (a - b)
#define MULTIPLY(a, b) (a * b)
#define DIVIDE(a, b) (a / b)
#define sigmoid(x) 1 / (1 + exp(-x))
#define tanh(x) 2 / (1 + exp(-2 * x)) - 1
#define relu(x) x > 0 ? x : 0
#define selu(x) x > 0 ? 1.05070098 * x : 1.05070098 * 1.67326324 * (exp(x) - 1)
#define softplus(x) log(exp(x) + 1)
#define softsign(x) x / (abs(x) + 1)
#define exponential(x) exp(x)
#define elu(x) x > 0 ? x : 1.67326324 * (exp(x) - 1)

float *softmax(float vector[], int len)
{
	float* result = (float*) malloc(len * sizeof(float));

	if(!result)
		return NULL;

	for(int i = 0; i < len; i++)
	{
		float sum = 0;
		for(int j = 0; j < len; j++)
		{
			sum += exp(vector[j]);
		}
		result[i] = exp(vector[i]) / sum;
	}
	return result;
}

static const float bias_0[12] = {-0.93199986, 0.0, 0.37007192, 0.37007192, 0.37007192, 0.37007192, 0.37007192, 0.37007192, 0.37007192, 0.37007192, 0.8765851, -0.93199986};

static const float weights_0[12][8] = {
		{0.8057493, 2.9795527, -1.8304529, 0.9894085, 5.2013063, -0.24433255, -2.677352, -3.7514267},
		{1.4663655, -3.6308842, -1.5362349, -4.009607, -3.3899207, -0.027803183, 4.616617, 3.4973888},
		{1.3878328, -2.0653377, -5.477129, 5.183858, 2.957729, -1.4176824, -3.226624, -2.345766},
		{3.066947, 0.41240513, -5.1610045, -3.195979, 3.5230298, -0.017952919, -1.0718038, -2.9149697},
		{-0.038537443, 0.0068383217, -0.39885193, 0.34447932, -0.5382516, 0.1257512, 0.26954144, -0.47634006},
		{0.14748377, 0.4864428, 0.4029802, -0.24346358, -0.24610823, -0.22758248, -0.11736959, 0.04549527},
		{0.06820965, -0.01937902, -0.36652887, -0.24539968, 0.45496237, 0.18126553, -0.5163497, -0.544387},
		{3.017939, -0.3651233, -2.3478413, 1.595007, -0.72729844, 3.3830914, -3.669575, -2.2866855},
		{-2.6295967, -2.0683885, -2.2921042, -3.4743116, 2.1029744, 0.38921285, 0.5893163, 1.0628531},
		{-1.5121658, -2.9182389, -1.6368313, -2.3079128, -2.7442517, 2.8849926, 2.542214, -1.8254087},
		{0.5748012, -2.8266726, 3.5819895, 1.6029497, 1.0627321, -3.8038511, 2.7501047, -1.8191012},
		{0.3940056, 0.07843971, 3.0493143, 1.9242697, -0.8762628, -2.8319213, 2.2223256, -1.4493481}
};

static const float bias_1[6] = {0.0, 0.0, 0.0, 0.0, 0.0, -0.11888974};

static const float weights_1[6][12] = {
		{0.5492141, -0.1414111, 0.39757967, -0.36158502, 0.09833443, -0.47393, -0.53185976, 0.0022592545, 0.5130632, -0.12995702, -0.22733217, 0.033081234},
		{-0.21178064, 0.4903823, -0.1481483, 0.48766124, 0.45324123, 0.5380161, 0.43851972, -0.36960223, -0.37254328, -0.103924334, -0.5617828, 0.4826399},
		{0.039447784, -0.100746095, -0.23990247, 0.0060834885, -0.07021153, -0.23689866, 0.1659441, 0.40832454, -0.3951022, -0.29026362, -0.25706536, -0.31385604},
		{-0.13016433, 0.23215353, -0.29324266, 0.43470788, 0.07804537, -0.10528472, 0.48228145, -0.46429664, 0.47453022, 0.23016626, 0.1630376, -0.33658704},
		{0.42304254, 0.051145613, 0.11585218, 0.4928739, -0.1141032, -0.1871528, 0.024568796, 0.43485725, -0.378761, 0.31970137, 0.21368355, -0.41898483},
		{0.21879745, -0.21437877, 0.32932395, -1.6440723, 0.1259619, 0.68972754, -1.601022, 1.214637, 0.006122768, 1.0816741, -0.8582495, 1.6706926}
};

static const float bias_2[1] = {-0.25777423};

static const float weights_2[1][6] = {
		{-6.2845855, 6.2749987, -6.1390553, -0.5799904, 3.8365345, 4.5463257}
};

void ESP_NN_GA(const float input[INPUT_SIZE], float output[OUTPUT_SIZE])
{
	float output_0[12];

	for(int i = 0; i < 12; i++)
	{
		float res = 0;
		for(int j = 0; j < 8; j++)
		{
			res += input[j] * weights_0[i][j];
		}
		output_0[i] = selu(res + bias_0[i]);
	}

	float output_1[6];

	for(int i = 0; i < 6; i++)
	{
		float res = 0;
		for(int j = 0; j < 12; j++)
		{
			res += output_0[j] * weights_1[i][j];
		}
		output_1[i] = selu(res + bias_1[i]);
	}

	float output_2[1];

	for(int i = 0; i < 1; i++)
	{
		float res = 0;
		for(int j = 0; j < 6; j++)
		{
			res += output_1[j] * weights_2[i][j];
		}
		output_2[i] = sigmoid(res + bias_2[i]);
	}
	output[0] = output_2[0];
}