#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#define INPUT_SIZE 8
#define OUTPUT_SIZE 1

#define ADD(a, b) (a + b)
#define SUBTRACT(a, b) (a - b)
#define MULTIPLY(a, b) (a * b)
#define DIVIDE(a, b) (a / b)
#define sigmoid(x) 1 / (1 + exp(-x))
#define tanh(x) 2 / (1 + exp(-2 * x)) - 1
#define relu(x) x > 0 ? x : 0
#define selu(x) x > 0 ? 1.05070098 * x : 1.05070098 * 1.67326324 * (exp(x) - 1)
#define softplus(x) log(exp(x) + 1)
#define softsign(x) x / (abs(x) + 1)
#define exponential(x) exp(x)
#define elu(x) x > 0 ? x : 1.67326324 * (exp(x) - 1)

float *softmax(float vector[], int len)
{
	float* result = (float*) malloc(len * sizeof(float));

	if(!result)
		return NULL;

	for(int i = 0; i < len; i++)
	{
		float sum = 0;
		for(int j = 0; j < len; j++)
		{
			sum += exp(vector[j]);
		}
		result[i] = exp(vector[i]) / sum;
	}
	return result;
}

static const float bias_0[12] = {-0.4121849, -0.4121849, -0.4121849, -0.4121849, -0.4121849, -0.4121849, 0.0, 0.0, 0.0, 0.0, 0.0, -0.4121849};

static const float weights_0[12][8] = {
		{-0.65122133, 0.4840064, 0.76267016, -0.96109074, -0.67427075, 0.16304386, 0.95939994, 0.39731586},
		{0.67351043, 0.60435224, -0.7284647, -0.36968333, 0.16622603, 0.3540696, -0.8141475, 1.0437996},
		{-0.9474956, -0.65804005, -0.22562182, -0.39036703, 0.73621905, 0.9954052, 0.69001067, -0.8668882},
		{0.5805836, 0.100906014, -0.920078, -0.7383562, 0.11325967, -0.28460026, 0.29103398, 0.30929565},
		{-0.3884452, 0.20763606, -0.25921488, -0.39498657, -0.113170415, -0.22012216, -0.08101255, 0.16450322},
		{-2.7617767, -0.66571444, 2.8686812, -1.0600219, -1.3556546, -2.0345583, -1.550386, 0.3838756},
		{-2.319314, -0.45566744, -1.0226603, 1.2016811, 2.1108303, 1.1039908, 0.65371084, 2.464602},
		{-3.047946, 1.9981924, -2.008429, -2.1482897, -1.7996037, 2.9008048, 0.97448516, 2.975197},
		{0.2696283, 0.112856746, -0.09186551, 0.29059982, 0.4582442, 0.027253032, -0.16845024, -0.46276188},
		{-0.19962439, 0.20077384, 0.31789923, 0.078606725, -0.25841975, -0.07287708, -0.15821207, 0.5228566},
		{-0.4655106, 0.40034276, 0.25500423, -0.2360504, 0.5030776, -0.05949098, -0.06721416, 0.22283524},
		{-1.0567571, -0.26322365, 0.010837913, -0.5004487, -0.40359867, 0.2191596, -0.24436057, 0.015475869}
};

static const float bias_1[6] = {0.0, 0.0, 0.0, 0.0, 0.0, 0.25158474};

static const float weights_1[6][12] = {
		{-0.114579886, 0.34806937, 0.33743262, 0.40198463, 0.037513196, 0.1973598, -0.013237476, 0.49448872, -0.20734787, -0.00790447, -0.17342034, 0.38172197},
		{0.22551906, 0.09958416, -0.4596263, 0.07023752, -0.07461637, 0.21773297, -0.117329895, -0.055887163, 0.43143952, 0.2028547, 0.3504594, 0.26930487},
		{-0.2981294, 0.3968767, 0.2890333, -0.25702214, 0.24870634, 0.12065029, -0.27831757, 0.09906387, -0.44365644, -0.11306545, -0.3209547, -0.31698856},
		{0.20203936, 0.47501993, 0.5180985, 0.54808605, 0.36263216, -0.22885984, -0.19341856, 0.048528016, -0.4162194, -0.37116045, -0.23363715, -0.21496549},
		{0.20742524, 0.15697652, -0.5486214, 0.043369412, -0.16106355, 0.077195406, -0.19139495, 0.005766213, -0.112124205, -0.5174065, 0.17196316, 0.2622292},
		{0.25109738, -0.24979988, -0.29772058, 0.36260998, -0.43162173, -0.1696432, -0.35875368, 0.36707854, 0.45960844, 0.21480721, 0.1855098, 0.49527943}
};

static const float bias_2[1] = {0.7191455};

static const float weights_2[1][6] = {
		{1.5512478, -8.47011, 8.496496, -0.35592914, 7.6561832, 8.1201515}
};

void ESP_NN_GA(const float input[INPUT_SIZE], float output[OUTPUT_SIZE])
{
	float output_0[12];

	for(int i = 0; i < 12; i++)
	{
		float res = 0;
		for(int j = 0; j < 8; j++)
		{
			res += input[j] * weights_0[i][j];
		}
		output_0[i] = selu(res + bias_0[i]);
	}

	float output_1[6];

	for(int i = 0; i < 6; i++)
	{
		float res = 0;
		for(int j = 0; j < 12; j++)
		{
			res += output_0[j] * weights_1[i][j];
		}
		output_1[i] = selu(res + bias_1[i]);
	}

	float output_2[1];

	for(int i = 0; i < 1; i++)
	{
		float res = 0;
		for(int j = 0; j < 6; j++)
		{
			res += output_1[j] * weights_2[i][j];
		}
		output_2[i] = sigmoid(res + bias_2[i]);
	}
	output[0] = output_2[0];
}